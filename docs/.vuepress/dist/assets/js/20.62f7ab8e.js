(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{445:function(t,a,s){"use strict";s.r(a);var e=s(31),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("本文将结合文本输入，细究 slate 内部执行逻辑。")])]),t._v(" "),s("ol",[s("li",[s("p",[t._v("光标先选中一个位置，触发 "),s("a",{attrs:{href:"https://github.com/ianstormtaylor/slate/blob/d2fc25c3c31453597f59cd2ac6ba087a1beb1fe3/packages/slate-react/src/components/editable.tsx#L274",target:"_blank",rel:"noopener noreferrer"}},[t._v("selectionchange"),s("OutboundLink")],1),t._v(" 事件，在事件中，通过 js 原生 getSelection 方法，获取到当前光标坐标 selection，再通过 slate-react 的 ReactEditor.toSlateRange 方法，获取 slate range，再使用 "),s("a",{attrs:{href:"http://Transforms.select",target:"_blank",rel:"noopener noreferrer"}},[t._v("Transforms.select"),s("OutboundLink")],1),t._v(" 将该 range 设置到 editor.selection 上，这里将执行 apply 的 "),s("a",{attrs:{href:"https://github.com/ianstormtaylor/slate/blob/d2fc25c3c31453597f59cd2ac6ba087a1beb1fe3/packages/slate/src/transforms/general.ts#L230",target:"_blank",rel:"noopener noreferrer"}},[t._v("set_selection"),s("OutboundLink")],1),t._v(" 操作（这个方法是在"),s("a",{attrs:{href:"https://github.com/ianstormtaylor/slate/blob/d2fc25c3c31453597f59cd2ac6ba087a1beb1fe3/packages/slate/src/create-editor.ts#L81",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),s("OutboundLink")],1),t._v("被触发的）。")])]),t._v(" "),s("li",[s("p",[t._v("输入 A 时，触发 slate-react 中的 "),s("a",{attrs:{href:"https://github.com/ianstormtaylor/slate/blob/d2fc25c3c31453597f59cd2ac6ba087a1beb1fe3/packages/slate-react/src/components/editable.tsx#L326",target:"_blank",rel:"noopener noreferrer"}},[t._v("beforeinput"),s("OutboundLink")],1),t._v(" 事件，判断到 event.inputType 为 insertText 时，使用 Editor.insertText 方法插入文本")])]),t._v(" "),s("li",[s("p",[t._v("在 Editor.insertText 中将执行 apply "),s("a",{attrs:{href:"https://github.com/ianstormtaylor/slate/blob/d2fc25c3c31453597f59cd2ac6ba087a1beb1fe3/packages/slate/src/transforms/general.ts#L45",target:"_blank",rel:"noopener noreferrer"}},[t._v("insert_text"),s("OutboundLink")],1),t._v(" 操作")])]),t._v(" "),s("li",[s("p",[t._v("以上的 apply 操作，都是对 Operation 的操作，当 Operation 处理完之后，会主动触发 "),s("a",{attrs:{href:"https://github.com/ianstormtaylor/slate/blob/d2fc25c3c31453597f59cd2ac6ba087a1beb1fe3/packages/slate/src/create-editor.ts#L95",target:"_blank",rel:"noopener noreferrer"}},[t._v("onChange"),s("OutboundLink")],1),t._v(" 事件，目的是 react 的重新渲染。")])]),t._v(" "),s("li",[s("p",[t._v("这里会有一个问题，当调用某个复杂命令时，会在一个 task 中执行多次 apply，这意味着 onChange 会被调用多次，而 slate 这里用了一个巧妙的方式：将 onChange 放在 Promise 的回调中，在当前 task 完成后才会调用一次 onChange 方法。")]),t._v(" "),s("div",{staticClass:"language-jsx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-jsx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// https://github.com/ianstormtaylor/slate/blob/d2fc25c3c31453597f59cd2ac6ba087a1beb1fe3/packages/slate/src/create-editor.ts#L90")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("apply")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("FLUSHING")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("editor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t  "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("FLUSHING")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("editor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\n\t  Promise"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t    "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("FLUSHING")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("editor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t    editor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onChange")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t    editor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("operations "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\t  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("ul",[s("li",[t._v("这里涉及了执行栈和队列的知识，我们知道 js 是单线程的，异步任务会被先放置于队列中，当同步任务执行完后，会执行队列中的异步任务。")]),t._v(" "),s("li",[t._v("异步任务中会分宏任务（task）和微任务（microtask），浏览器在每个 task 之间会执行 DOM 重新渲染的逻辑，也就是 task → 渲染 → task 。")]),t._v(" "),s("li",[t._v("而微任务将会在第一个 task 之后和渲染之前执行")]),t._v(" "),s("li",[t._v("Promise.then 是微任务，所以 slate 这里多次执行的 apply ，会将其中的 Promise.then 放到队列中，当同步任务执行完，在 DOM 重新渲染之前执行其中的 onChange 事件。")])])]),t._v(" "),s("li",[s("p",[t._v("onChange 会在 "),s("a",{attrs:{href:"https://github.com/ianstormtaylor/slate/blob/main/packages/slate-react/src/components/slate.tsx",target:"_blank",rel:"noopener noreferrer"}},[t._v("react 组件"),s("OutboundLink")],1),t._v("中更改 "),s("a",{attrs:{href:"https://github.com/ianstormtaylor/slate/blob/d2fc25c3c31453597f59cd2ac6ba087a1beb1fe3/packages/slate-react/src/components/slate.tsx#L29",target:"_blank",rel:"noopener noreferrer"}},[t._v("state 的 Hook"),s("OutboundLink")],1),t._v("，并且触发 "),s("a",{attrs:{href:"https://github.com/ianstormtaylor/slate/blob/d2fc25c3c31453597f59cd2ac6ba087a1beb1fe3/packages/slate-react/src/components/slate.tsx#L99",target:"_blank",rel:"noopener noreferrer"}},[t._v("Context.Provider"),s("OutboundLink")],1),t._v(" 的值的改变，从而更新组件。")])])]),t._v(" "),s("p",[t._v("上一篇 "),s("RouterLink",{attrs:{to:"/post/html-different-space-slate.html"}},[t._v("slate 系列 - 不同空格的处理")])],1)])}),[],!1,null,null,null);a.default=n.exports}}]);